name: Semgrep Full Scan

on: push

jobs:

  semgrep-full:
      runs-on: self-hosted
      container:
        image: returntocorp/semgrep

      steps:

        # step 1
        - name: clone application source code
          uses: actions/checkout@v3

        # step 2
        - name: full scan
          run: |
            echo ${{ github.event.repository.name }}
            apk add curl
            semgrep --config=auto . --json > report.json
            echo "IyEvYmluL2Jhc2gKI0NyZWF0ZSBwcm9kdWN0IGluIERlZmVjdERvam8KY3VybCAtWCBQT1NUIC1IICJDb250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL2pzb24iIC1IICJBdXRob3JpemF0aW9uOiBUb2tlbiA0NzRjZWE0YTIzODJmMGUyYjk2NjcxODY1NjNlOTkyNzcxNWM0ZDNkIiAtZCAneyJuYW1lIjoiJyIke3sgZ2l0aHViLmV2ZW50LnJlcG9zaXRvcnkubmFtZSB9fSInIiwiZGVzY3JpcHRpb24iOiJhdXRvbWF0ZWQgcHJvZHVjdCBpbXBvcnQgdmlhIEdCIEFjdGlvbnMiLCJwcm9kX3R5cGUiOjF9JyBodHRwOi8vMTAuMTIwLjAuMTY3OjgwODAvYXBpL3YyL3Byb2R1Y3RzLwojRmV0Y2ggUHJvZHVjdCBJRCBmcm9tIHByb2R1Y3QgTmFtZQpjdXJsIC1YICdHRVQnICdodHRwOi8vMTAuMTIwLjAuMTY3OjgwODAvYXBpL3YyL3Byb2R1Y3RzLz9wcmVmZXRjaD0nIC1IICdhY2NlcHQ6IGFwcGxpY2F0aW9uL2pzb24nIC1IICJBdXRob3JpemF0aW9uOiBUb2tlbiA0NzRjZWE0YTIzODJmMGUyYjk2NjcxODY1NjNlOTkyNzcxNWM0ZDNkIiA+IC90bXAvZGpfcHJvZHVjdHMuanNvbgojRmV0Y2ggRW5nYWdlbWVudCBJRCBhbmQgY2hlY2sgaWYgZXhpdHMgYmVmb3JlIGNyZWF0aW5nCmN1cmwgLVggJ0dFVCcgJ2h0dHA6Ly8xMC4xMjAuMC4xNjc6ODA4MC9hcGkvdjIvZW5nYWdlbWVudHMvP3ByZWZldGNoPScgLUggJ2FjY2VwdDogYXBwbGljYXRpb24vanNvbicgLUggJ0F1dGhvcml6YXRpb246IFRva2VuIDQ3NGNlYTRhMjM4MmYwZTJiOTY2NzE4NjU2M2U5OTI3NzE1YzRkM2QnID4gL3RtcC9kal9lbmdhZ2VtZW50cy5qc29uCmlmIFsgIiQoY2F0IC90bXAvZGpfZW5nYWdlbWVudHMuanNvbnwganEgJy5yZXN1bHRzW10gfCBzZWxlY3QoLm5hbWU9PSInIiRlY2hvIkNJQ0QtIiR7eyBnaXRodWIuZXZlbnQucmVwb3NpdG9yeS5uYW1lIH19IiciKSB8IC5pZCcpIiBdCnRoZW4KICAgZWNobyAiaW1wb3J0aW5nIHNjYW4gdG8gZXhpc3RpbmcgQ0lDRCBlbmdhZ2VtZW50IgogICBjdXJsIC1YIFBPU1QgImh0dHA6Ly8xMC4xMjAuMC4xNjc6ODA4MC9hcGkvdjIvcmVpbXBvcnQtc2Nhbi8iIC1IICAiYWNjZXB0OiBhcHBsaWNhdGlvbi9qc29uIiAtSCAgIkNvbnRlbnQtVHlwZTogbXVsdGlwYXJ0L2Zvcm0tZGF0YSIgIC1IICJBdXRob3JpemF0aW9uOiBUb2tlbiA0NzRjZWE0YTIzODJmMGUyYjk2NjcxODY1NjNlOTkyNzcxNWM0ZDNkIiAtRiAibWluaW11bV9zZXZlcml0eT1JbmZvIiAtRiAiYWN0aXZlPXRydWUiIC1GICJzY2FuX3R5cGU9U2VtZ3JlcCBKU09OIFJlcG9ydCIgLUYgImNsb3NlX29sZF9maW5kaW5ncz1mYWxzZSIgLUYgInB1c2hfdG9famlyYT1mYWxzZSIgLUYgImZpbGU9QC4vcmVwb3J0Lmpzb24iIC1GICJwcm9kdWN0X25hbWU9JHt7IGdpdGh1Yi5ldmVudC5yZXBvc2l0b3J5Lm5hbWUgfX0iIC1GICJzY2FuX2RhdGU9MjAyMi0wNi0xNCIgLUYgImVuZ2FnZW1lbnRfbmFtZT1DSUNELSR7eyBnaXRodWIuZXZlbnQucmVwb3NpdG9yeS5uYW1lIH19IgplbHNlCiAgIGVjaG8gImNyZWF0aW5nIG5ldyBDSUNEIGVuZ2FnZW1lbnQiCiAgIGN1cmwgLVggJ1BPU1QnICdodHRwOi8vMTAuMTIwLjAuMTY3OjgwODAvYXBpL3YyL2VuZ2FnZW1lbnRzLycgLUggJ2FjY2VwdDogYXBwbGljYXRpb24vanNvbicgLUggJ0NvbnRlbnQtVHlwZTogYXBwbGljYXRpb24vanNvbicgLUggJ0F1dGhvcml6YXRpb246IFRva2VuIDQ3NGNlYTRhMjM4MmYwZTJiOTY2NzE4NjU2M2U5OTI3NzE1YzRkM2QnIC1kICd7Im5hbWUiOiAiJyIkZWNobyJDSUNELSIke3sgZ2l0aHViLmV2ZW50LnJlcG9zaXRvcnkubmFtZSB9fSInIiwiZGVzY3JpcHRpb24iOiAiQ0lDRCBFbmdhZ2VtZW50IiwidGFyZ2V0X3N0YXJ0IjogIjIwMjMtMDQtMTEiLCJ0YXJnZXRfZW5kIjogIjIwMjMtMDQtMTEiLCJlbmdhZ2VtZW50X3R5cGUiOiAiQ0kvQ0QiLCJkZWR1cGxpY2F0aW9uX29uX2VuZ2FnZW1lbnQiOiB0cnVlLCJsZWFkIjogMSwicHJvZHVjdCI6IDF9JwogICBjdXJsIC1YIFBPU1QgImh0dHA6Ly8xMC4xMjAuMC4xNjc6ODA4MC9hcGkvdjIvcmVpbXBvcnQtc2Nhbi8iIC1IICAiYWNjZXB0OiBhcHBsaWNhdGlvbi9qc29uIiAtSCAgIkNvbnRlbnQtVHlwZTogbXVsdGlwYXJ0L2Zvcm0tZGF0YSIgIC1IICJBdXRob3JpemF0aW9uOiBUb2tlbiA0NzRjZWE0YTIzODJmMGUyYjk2NjcxODY1NjNlOTkyNzcxNWM0ZDNkIiAtRiAibWluaW11bV9zZXZlcml0eT1JbmZvIiAtRiAiYWN0aXZlPXRydWUiIC1GICJzY2FuX3R5cGU9U2VtZ3JlcCBKU09OIFJlcG9ydCIgLUYgImNsb3NlX29sZF9maW5kaW5ncz1mYWxzZSIgLUYgInB1c2hfdG9famlyYT1mYWxzZSIgLUYgImZpbGU9QC4vcmVwb3J0Lmpzb24iIC1GICJwcm9kdWN0X25hbWU9JHt7IGdpdGh1Yi5ldmVudC5yZXBvc2l0b3J5Lm5hbWUgfX0iIC1GICJzY2FuX2RhdGU9MjAyMi0wNi0xNCIgLUYgImVuZ2FnZW1lbnRfbmFtZT1DSUNELSR7eyBnaXRodWIuZXZlbnQucmVwb3NpdG9yeS5uYW1lIH19IiAgICAgICAgIApmaQ==" | base64 --decode > dj.sh
            chmod +x dj.sh
            ./dj.sh
            

        # step 3
        - name: save report as pipeline artifact
          uses: actions/upload-artifact@v3
          with:
            name: report.json
            path: report.json
            
        # step 4
        - name: Cleanup
          if: ${{ always() }}
          run: docker ps -q | xargs -n 1 -P 8 -I {} docker stop {}
            
